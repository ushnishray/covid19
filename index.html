<!DOCTYPE html>
<html>
  <head>
    <style>
      /*
            Copyright Ushnish Ray (2020)
            All rights reserved. You may not reproduce or modify this code without permission.
      */

      /* Set the size of the div element that contains the map */
      #map {
        padding-top: 20px;
        height: 500px;  /* The height is 400 pixels */
        width: 450px;  /* The width is the width of the web page */
       }

       #achart{
          background-color: white;
          position: static;
          width: 440px;
          height: 300px;
      }

      .infotable{
          width: 450px;
      }

       #info-box {
        background-color: white;
        border: 1px solid black;
        
        height: 20px;
        width: 220px;
        padding: 10px;
      }

      #loc-box{
        background-color: white;
        border: 1px solid black;
        
        height: 20px;
        padding: 10px;
      }
      
      #casedate{
        background-color: white;
        border: 1px solid black;
        
        height: 20px;
        width: 170px;
        padding: 10px;
      }

      #storage{
        background-color: white;
        border: 1px solid black;
        
        height: 20px;
        padding: 10px;
      }

      .mapstruct{
          float: left;
          display: inline-block;
          padding-right: 25px;
          padding-bottom: 25px;
      }


      .charstruct{
          float: left;
          display: inline-block;
      }

      .textstruct{
          clear: both;
          text-align: center;
      }

      #mheader{
          color: white;
          text-align: center;
      }
    </style>
  </head>

  <body>
      <header>
        <h3 id="mheader">NUMBER OF REPORTED CASES OF COVID-19 IN DIFFERENT PARTS OF LA</h3>
      </header>
      
     
    <article class="mapstruct"> 
        <div id="map"></div>
    </article>
   
    <article class="chartstruct">
        <div id="storage" hidden="false">A</div>
        <h3 style="color:white">
            <u>Trend of Cases in Selected Location</u>
        </h3>        
        
        <!--
        <h4  style="color:white">            
            Data set size too small for proper analysis.
        </h4>
        -->

        <table border=1>
            <tr>
                <td>
                    <table id="anTab" cellpadding=0 cellspacing=0> 
                        <tr>
                            <td>
                                <canvas id="achart"></canvas>
                            </td>
                        </tr>  
                    </table>
                </td>
            </tr>
        </table>

        <table border=1 cellpadding="5px" class="infotable">
            <tr>
                <td style="color:white" >Location selected:</td>
                <td><div id="loc-box"><center>None Selected</center></div></td>
            </tr>
            <tr>
                <td style="color:white">Number of Cases Reported: </td>
                <td><div id="info-box">0</div></td>
            </tr>
            <tr>
                <td style="color:white">Date:</td>
                <td><center>
                    <input type="date" id="casedate" name="casedate" value="2020-03-27" onchange="dateChange()">
                    </center>
                </td>
            </tr>
        </table>
    </article>

    <script src="./charjs/node_modules/moment/moment.js"></script>
    <script>
        moment().format();
    </script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="./charjs/node_modules/chart.js/dist/Chart.js"></script>
    <script>
      var map;
      var service;
      var gdate;
      var losangeles = {lat: 34.0522, lng: -118.2437};
      var myfetch;

      // Initialize and add the map
      function initMap() {
        // Default date
        gdate = 'mar27_2020';
        
        myfetch = loadMasterData();
        loadData(gdate, myfetch);

        //loadLocData(myfetch,1);
        //play();
      }

      //////////////////
      //All to do with google maps
      //Date changed
      datesavail=['2020-03-16','2020-03-17','2020-03-18','2020-03-19','2020-03-20',
      '2020-03-21','2020-03-22','2020-03-23','2020-03-24','2020-03-25','2020-03-26',
      '2020-03-27'];
      codes = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
      function dateChange(){
          var obj = document.getElementById('casedate');
          
          sdate = obj.value;

          if(!datesavail.includes(sdate)){
            delete map;
            map = new google.maps.Map(document.getElementById('map'), {zoom: 10, center: losangeles});
            return;
            //sdate = datesavail[datesavail.length-1];
            //obj.style.color = 'red';
          }
          
          year = sdate.substring(0,4);
          month = sdate.substring(5,7);
          day = sdate.substring(8,10);
          
          fdate = codes[parseInt(month)-1] + day + '_' + year;
          loadData(fdate, myfetch);
      }

      //Load data from JSON
      function loadData(fdate, myfetch){
        //console.log(fdate);
       
        delete map;
        map = new google.maps.Map(document.getElementById('map'), {zoom: 10, center: losangeles});

        var script = document.createElement('script');
        script.src = './rawdata/' + fdate + '.js';
        document.getElementsByTagName('head')[0].appendChild(script);

        map.data.setStyle(function(feature){
            var magnitude = feature.getProperty('mag')*0.75;
            return{
                icon: getCircle(magnitude)
            };
        });
        
        map.data.addListener('mouseover', function(event){
            map.data.revertStyle();
            map.data.overrideStyle(event.feature,{strokeWeight: 2});
            
            document.getElementById('info-box').textContent = event.feature.getProperty('mag');
            document.getElementById('loc-box').textContent = event.feature.getProperty('place');
            loadLocData(myfetch,event.feature.getProperty('id'));
        });

        map.data.addListener('click', function(event){
            map.data.revertStyle();
            map.data.overrideStyle(event.feature,{strokeWeight: 2});
            
            document.getElementById('info-box').textContent = event.feature.getProperty('mag');
            document.getElementById('loc-box').textContent = event.feature.getProperty('place');
            loadLocData(myfetch,event.feature.getProperty('id'));
        });

      }

      function eqfeed_callback(results){
          map.data.addGeoJson(results);
      }

      function getCircle(magnitude) {
        return {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: 'red',
          fillOpacity: .5,
          scale: magnitude,
          strokeColor: 'white',
          strokeWeight: .5
        };
      }
    </script>
    
    
    <br>
   
    <div class="textstruct">
        <p style="color:red">
            PLEASE NOTE: AREA OF THE CIRCLES DOES NOT INDICATE AREA OVER WHICH CONTAGION IS SPREAD/ACTIVE -
            JUST THE NUMBER OF CASES. 
        </p>

        <p style="color:red">
          The size of the circles will also be rescaled to accommodate the ever-increasing cases. Use earlier 
          dates as a reference. 
        </p>

        <p style="color:white">
            Data is from: <a href="http://www.publichealth.lacounty.gov/media/Coronavirus/" style="color:red" target="_blank">
                http://www.publichealth.lacounty.gov/media/Coronavirus/</a>
        </p>

        <p style="color:white">
        Earliest available date: Mar 16, 2020.
        </p>

    </div>
 

    <script>
    //////////////////
    //All to do with charts

    function populateAll()
    {
        tabobj = document.getElementById("anTab");
        var rowobj = tabobj.rows[0];

        data = document.getELementById("mapdata");
        console.log(data.length)
        for(var i=0;i<data.length;i++)
        {
            var elem = document.createElement('canvas');
            
            elem.style.cssText="position:relative;z-index:";
            elem.style.cssText+=baseobj.zIndex+i+1;
            elem.style.cssText+="background-color:white;";
            //elem.style.top = 0 + "px"; //rect.top + "px";
            //elem.style.left = 0 + "px"; //rect.left + "px";
            elem.style.height = "160px";
            elem.style.width = "250px";
            //elem.hidden = true;
        
            elem.id = 'acanvas' + i.toString();  

            rowobj.deleteCell(0);
            var x = rowobj.insertCell(-1);
            x.appendChild(elem);
            
            //Next plot to canvas
            //But combine data as needed
            var mdata = data[i].x.map((v,p) => ({x: p, y: data[i].y[p]}));
            populate(elem,data[i].x,mdata);
            

            //elem.hidden = true;
        }
    }

    function loadMasterData()
    {
        /*
        $.getJSON('./rawdata/test.json',function(data){            
        })
        .fail(function(){
            console.log('FAIL');
        })
        .done(function(data){
            var script = document.createElement('script');
            script.src = data;
            script.id = 'mapdata';
            document.getElementsByTagName('head')[0].appendChild(script);
        });
        */

        /*
        var client = new XMLHttpRequest();
        client.open('GET','./rawdata/test.json');
        client.onload = function()
        {
            var script = document.createElement('script');
            script.src = client.responseText;
            script.id = 'mapdata';
            document.getElementsByTagName('head')[0].appendChild(script);
        }
        client.send();
        */

        
        let myfetch = fetch('./rawdata/test.json').then(function(response){
            return response.text();
        }).then(function(text){
            /*
            var lscript = document.createElement('div');
            lscript.textContent = text;
            lscript.id = 'mapdata';
            lscript.hidden = true;
            document.body.appendChild(lscript);
            */
            return text
        });
        /*
        .then(function(text){
            sobj = document.getElementById('mapdata');   
            //console.log(sobj.textContent); 
            jobj = JSON.parse(sobj.textContent);              
            for(ldata in jobj){
                console.log(ldata.id);
            }
            return jobj;         
        });
        */
            
        return myfetch;
    } 

    function loadLocData(myfetch, locationID)
    { 
        myfetch.then(function(text){
            jobj = JSON.parse(text);          
            for (idx in jobj)
            {
                ldata = jobj[idx];
                //console.log(ldata.id);                
                if(locationID == ldata.id)
                {                    
                    //Next plot to canvas
                    //But combine data as needed
                    //console.log(ldata.x); //Note there is a bug with Date where counter is WRONG
                    var mdata = ldata.x.map((v,p) => ({x: new Date(v), y: ldata.y[p]}));
                    populate(ldata,mdata);
                }
            }
        });
    }

    function populate(ldata,mdata)
    {
        //console.log(mdata);
        //console.log(mdata);
        var ctx = document.getElementById('achart');
        var chart = new Chart(ctx,{
            type:'scatter',
            data:{
                datasets: [{
                    label: ldata.place,
                    data: mdata,
                    pointBackgroundColor: 'rgba(63,63,191,1)'
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'series',
                        time: {                                
                            displayFormats: {
                                unit: 'day'
                            }
                        },
                        position:"bottom"
                    }],
                    yAxes: [{
                        ticks:{
                            min:0,
                            stepSize: 1                            
                        },
                        scaleLabel:{
                            display: true,
                            labelString: 'Number of Cases'
                        }
                    }]
                },
                 legend:{
                        display: false                    
                }
            }            
        })
    }
 
    </script>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIt8L9M3-xq6B3UAsPwzjaNawpYRwd30c&libraries=places&callback=initMap">
    </script>
  </body>
</html>
